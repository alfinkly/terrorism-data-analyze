"""
Target Vulnerability Analysis
Analyzes which targets are most frequently attacked and most deadly.
"""

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# Configuration
USE_FULL_DATASET = True


def load_data():
    """Loads the terrorism data from Excel file."""
    file_path = "gtd.xlsx" if USE_FULL_DATASET else "gtd-mini.xlsx"
    try:
        df = pd.read_excel(file_path)
        print(f"Successfully loaded {file_path}")
        return df
    except FileNotFoundError:
        print(f"Error: {file_path} not found.")
        return None


def prepare_data(df):
    """Renames columns and prepares data for analysis."""
    df.rename(
        columns={
            "iyear": "Year",
            "imonth": "Month",
            "iday": "Day",
            "country_txt": "Country",
            "region_txt": "Region",
            "attacktype1_txt": "AttackType",
            "target1": "Target",
            "nkill": "Killed",
            "nwound": "Wounded",
            "gname": "Group",
            "targtype1_txt": "Target_type",
            "weaptype1_txt": "Weapon_type",
        },
        inplace=True,
    )

    df["Killed"] = pd.to_numeric(df["Killed"], errors="coerce").fillna(0)
    df["Wounded"] = pd.to_numeric(df["Wounded"], errors="coerce").fillna(0)
    df["Casualties"] = df["Killed"] + df["Wounded"]
    return df


def analyze_target_frequency(df):
    """Analyzes which targets are most frequently attacked."""
    target_counts = df["Target_type"].value_counts()

    plt.figure(figsize=(12, 8))
    colors = sns.color_palette("Reds_r", len(target_counts))
    bars = plt.barh(target_counts.index, target_counts.values, color=colors)
    plt.xlabel("Number of Attacks")
    plt.title("Most Frequently Attacked Target Types")
    plt.gca().invert_yaxis()
    plt.tight_layout()
    plt.savefig("attachments/target_frequency.png", dpi=150)
    plt.show()
    print("Saved: target_frequency.png")

    print("\n" + "=" * 60)
    print("TARGET FREQUENCY RANKING")
    print("=" * 60)
    for i, (target, count) in enumerate(target_counts.items(), 1):
        pct = count / target_counts.sum() * 100
        print(f"{i:2}. {target}: {count:,} attacks ({pct:.1f}%)")


def analyze_target_lethality(df):
    """Analyzes which targets result in most casualties."""
    target_stats = df.groupby("Target_type").agg(
        {"Killed": ["sum", "mean"], "Wounded": ["sum", "mean"], "Year": "count"}
    )
    target_stats.columns = [
        "Total_Killed",
        "Avg_Killed",
        "Total_Wounded",
        "Avg_Wounded",
        "Attacks",
    ]
    target_stats["Avg_Casualties"] = (
        target_stats["Avg_Killed"] + target_stats["Avg_Wounded"]
    )
    target_stats["Total_Casualties"] = (
        target_stats["Total_Killed"] + target_stats["Total_Wounded"]
    )

    fig, axes = plt.subplots(1, 2, figsize=(16, 7))

    # Total casualties
    ax1 = axes[0]
    stats_total = target_stats.sort_values("Total_Casualties", ascending=True)
    ax1.barh(
        stats_total.index, stats_total["Total_Killed"], color="darkred", label="Killed"
    )
    ax1.barh(
        stats_total.index,
        stats_total["Total_Wounded"],
        left=stats_total["Total_Killed"],
        color="orange",
        label="Wounded",
    )
    ax1.set_xlabel("Total Casualties")
    ax1.set_title("Total Casualties by Target Type")
    ax1.legend()

    # Average casualties per attack
    ax2 = axes[1]
    stats_avg = target_stats.sort_values("Avg_Casualties", ascending=True)
    ax2.barh(stats_avg.index, stats_avg["Avg_Casualties"], color="steelblue")
    ax2.set_xlabel("Average Casualties per Attack")
    ax2.set_title("Deadliness by Target Type (Avg per Attack)")

    plt.tight_layout()
    plt.savefig("target_lethality.png", dpi=150)
    plt.show()
    print("Saved: target_lethality.png")

    print("\n" + "=" * 60)
    print("TARGET LETHALITY RANKING (by avg casualties)")
    print("=" * 60)
    for target, row in target_stats.sort_values(
        "Avg_Casualties", ascending=False
    ).iterrows():
        print(f"{target}: {row['Avg_Casualties']:.2f} avg casualties/attack")


def analyze_target_by_region(df):
    """Analyzes target preferences by region."""
    top_regions = df["Region"].value_counts().nlargest(6).index.tolist()
    top_targets = df["Target_type"].value_counts().nlargest(8).index.tolist()

    df_filtered = df[
        df["Region"].isin(top_regions) & df["Target_type"].isin(top_targets)
    ]
    pivot = (
        pd.crosstab(
            df_filtered["Region"], df_filtered["Target_type"], normalize="index"
        )
        * 100
    )

    plt.figure(figsize=(14, 8))
    sns.heatmap(
        pivot, annot=True, fmt=".1f", cmap="YlOrRd", cbar_kws={"label": "% of Attacks"}
    )
    plt.title("Target Preferences by Region (%)")
    plt.tight_layout()
    plt.savefig("target_by_region_heatmap.png", dpi=150)
    plt.show()
    print("Saved: target_by_region_heatmap.png")


def analyze_target_trends(df):
    """Analyzes how target preferences have changed over time."""
    top_targets = df["Target_type"].value_counts().nlargest(6).index.tolist()
    df_top = df[df["Target_type"].isin(top_targets)]

    yearly_targets = (
        pd.crosstab(df_top["Year"], df_top["Target_type"], normalize="index") * 100
    )

    plt.figure(figsize=(14, 6))
    for target in top_targets:
        if target in yearly_targets.columns:
            plt.plot(
                yearly_targets.index, yearly_targets[target], linewidth=2, label=target
            )

    plt.xlabel("Year")
    plt.ylabel("Percentage of Attacks")
    plt.title("Target Type Trends Over Time")
    plt.legend(title="Target Type", bbox_to_anchor=(1.05, 1), loc="upper left")
    plt.grid(True, alpha=0.3)
    plt.tight_layout()
    plt.savefig("target_trends.png", dpi=150)
    plt.show()
    print("Saved: target_trends.png")


def analyze_attack_target_matrix(df):
    """Creates a matrix of attack types vs target types."""
    top_attacks = df["AttackType"].value_counts().nlargest(6).index.tolist()
    top_targets = df["Target_type"].value_counts().nlargest(8).index.tolist()

    df_filtered = df[
        df["AttackType"].isin(top_attacks) & df["Target_type"].isin(top_targets)
    ]
    pivot = pd.crosstab(df_filtered["AttackType"], df_filtered["Target_type"])

    plt.figure(figsize=(14, 8))
    sns.heatmap(
        pivot,
        annot=True,
        fmt="d",
        cmap="Blues",
        cbar_kws={"label": "Number of Attacks"},
    )
    plt.title("Attack Type vs Target Type Matrix")
    plt.tight_layout()
    plt.savefig("attachments/attack_target_matrix.png", dpi=150)
    plt.show()
    print("Saved: attack_target_matrix.png")


def analyze_central_asia_targets(df):
    """Analyzes target patterns specifically in Central Asia."""
    ca_df = df[df["Region"] == "Central Asia"]

    if ca_df.empty:
        print("No data for Central Asia.")
        return

    target_stats = ca_df.groupby("Target_type").agg({"Year": "count", "Killed": "sum"})
    target_stats.columns = ["Attacks", "Killed"]
    target_stats = target_stats.sort_values("Attacks", ascending=False)

    fig, axes = plt.subplots(1, 2, figsize=(14, 6))

    ax1 = axes[0]
    target_stats["Attacks"].plot(kind="bar", ax=ax1, color="steelblue")
    ax1.set_xlabel("Target Type")
    ax1.set_ylabel("Number of Attacks")
    ax1.set_title("Target Types in Central Asia")
    ax1.tick_params(axis="x", rotation=45)

    ax2 = axes[1]
    target_stats["Killed"].plot(kind="bar", ax=ax2, color="darkred")
    ax2.set_xlabel("Target Type")
    ax2.set_ylabel("Total Killed")
    ax2.set_title("Deaths by Target Type in Central Asia")
    ax2.tick_params(axis="x", rotation=45)

    plt.tight_layout()
    plt.savefig("attachments/central_asia_targets.png", dpi=150)
    plt.show()
    print("Saved: central_asia_targets.png")

    print("\n" + "=" * 60)
    print("CENTRAL ASIA TARGET ANALYSIS")
    print("=" * 60)
    print(target_stats.to_string())


def run_analysis():
    """Main function to run the entire analysis pipeline."""
    df = load_data()
    if df is None:
        return

    # Prepare data
    df_clean = prepare_data(df)

    # --- Frequency Analysis ---
    print("--- Analyzing Frequency of Attacks by Target Type ---")
    analyze_target_frequency(df_clean)

    # --- Lethality Analysis ---
    print("\n--- Analyzing Lethality by Target Type ---")
    analyze_target_lethality(df_clean)

    # --- Regional Analysis of Top Targets ---
    print("\n--- Analyzing Regional Distribution for Top Targets ---")
    analyze_target_by_region(df_clean)

    # --- Temporal Analysis of Top Targets ---
    print("\n--- Analyzing Temporal Trends for Top Targets ---")
    analyze_target_trends(df_clean)

    # --- Attack/Target Matrix ---
    print("\n--- Analyzing Attack vs Target Matrix ---")
    analyze_attack_target_matrix(df_clean)

    # --- Central Asia Analysis ---
    print("\n--- Analyzing Targets in Central Asia ---")
    analyze_central_asia_targets(df_clean)

    print("\nTarget vulnerability analysis complete. Plots saved to 'attachments' directory.")


if __name__ == "__main__":
    run_analysis()
